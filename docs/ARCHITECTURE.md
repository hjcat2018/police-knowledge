# 公安专网知识库系统架构设计文档

> **文档版本**: 2.0.0  
> **最后更新**: 2025年1月20日  
> **技术栈版本**: Spring AI 1.1.2 | Spring AI Alibaba 1.1.2.0 | Spring Boot 3.5.7
> **应用场景**: 公安专网 | 面向基层民警 | 内部知识管理

## 一、架构概述

### 1.1 设计原则

本系统遵循以下核心架构设计原则：

- **公安专网适配**: 符合公安专网安全要求，支持物理隔离环境部署
- **松耦合**: 各模块之间通过接口通信，降低依赖
- **高内聚**: 每个模块职责单一，功能集中
- **可扩展**: 支持横向扩展，易于添加新功能
- **可观测**: 完善的监控、日志和追踪体系
- **安全性**: 完整的认证授权、数据保护和审计日志机制
- **分级管理**: 支持市局→区县局→派出所三级管理模式
- **MCP兼容**: 支持Model Context Protocol集成

### 1.2 应用场景

| 场景 | 描述 | 用户群体 |
|------|------|----------|
| 日常查询 | 民警日常查询法律法规、规章制度 | 全体民警 |
| 业务学习 | 培训资料、业务指导文件学习 | 全体民警 |
| 执法参考 | 执法依据推荐、案件办理参考 | 办案民警 |
| 知识管理 | 知识录入、审核、发布管理 | 管理员 |

### 1.3 架构风格

本系统采用**分层架构**结合**微服务架构**的风格，具体包括：

- **表现层**: RESTful API + WebSocket + 前后端分离
- **应用层**: 业务服务编排、权限控制、审计日志
- **领域层**: 核心业务逻辑、文档处理、RAG检索
- **基础设施层**: 数据存储、外部服务对接、消息队列

---

## 二、系统架构图

### 2.1 整体架构（公安专网适配）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           公安专网边界                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         客户端层                                      │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │   │
│  │  │   Web应用    │  │  移动终端   │  │  管理后台   │                  │   │
│  │  │  (民警查询)  │  │  (执法现场) │  │  (管理员)   │                  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                               │ HTTPS / WebSocket                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                     接入层 (Gateway Layer)                          │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │              公安专网网关 + Spring Cloud Gateway              │ │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────┐ │ │   │
│  │  │  │ 路由转发  │ │ 认证授权  │ │  限流熔断 │ │  安全审计     │ │ │   │
│  │  │  │          │ │ (专网SSO) │ │          │ │  (日志记录)   │ │ │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      服务层 (Service Layer)                         │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────┐ │ │   │
│  │  │  │ 知识库服务   │ │  文档服务   │ │  问答服务   │ │用户服务 │ │ │   │
│  │  │  │KnowledgeBase│ │ Document    │ │    Chat     │ │ User    │ │ │   │
│  │  │  │  Service    │ │  Service    │ │  Service    │ │ Service │ │ │   │
│  │  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────┘ │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐ │ │   │
│  │  │  │                   RAG服务层                             │ │ │   │
│  │  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌─────────┐│ │ │   │
│  │  │  │  │  检索服务  │ │  重排序   │ │  上下文   │ │生成服务 ││ │ │   │
│  │  │  │  │Retriever │ │ Reranker │ │  Builder  │ │Generator││ │ │   │
│  │  │  │  └───────────┘ └───────────┘ └───────────┘ └─────────┘│ │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘ │ │   │
│  │  │  ┌─────────────────────────────────────────────────────────┐ │ │   │
│  │  │  │              权限管理与审计服务                         │ │ │   │
│  │  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐             │ │ │   │
│  │  │  │  │权限控制   │ │ 审核流程  │ │ 审计日志  │             │ │ │   │
│  │  │  │  │          │ │          │ │          │             │ │ │   │
│  │  │  │  └───────────┘ └───────────┘ └───────────┘             │ │ │   │
│  │  │  └─────────────────────────────────────────────────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    AI处理层 (AI Processing Layer)                   │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │              Spring AI Alibaba Framework                      │ │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────────┐ │ │   │
│  │  │  │ChatClient │ │ Embedding │ │VectorStore│ │DocumentReader │ │ │   │
│  │  │  │+Advisors  │ │   Client  │ │           │ │               │ │ │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                              ↓                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                    外部服务集成                               │ │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │ │   │
│  │  │  │ 阿里云DashScope │  │  治安平台API    │  │ 统一身份认证  │ │ │   │
│  │  │  │ - 嵌入模型      │  │ - 数据同步      │  │ - 专网SSO    │ │ │   │
│  │  │  │ - 大语言模型    │  │ - 文档拉取      │  │              │ │ │   │
│  │  │  └─────────────────┘  └─────────────────┘  └───────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                               │                                            │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                       数据层 (Data Layer)                           │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                    OceanBase SeekDB                          │ │   │
│  │  │  ┌───────────────────┐  ┌───────────────────┐                │ │   │
│  │  │  │    向量存储引擎    │  │   全文索引引擎    │                │ │   │
│  │  │  │  Vector Engine    │  │  Full-Text Index  │                │ │   │
│  │  │  │  - HNSW索引       │  │  - 中文分词       │                │ │   │
│  │  │  │  - 余弦相似度     │  │  - 倒排索引       │                │ │   │
│  │  │  └───────────────────┘  └───────────────────┘                │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                              ↓                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                      缓存层 (Cache Layer)                     │ │   │
│  │  │  ┌─────────────────┐  ┌─────────────────────────────────────┐ │ │   │
│  │  │  │   Redis         │  │           Caffeine                  │ │ │   │
│  │  │  │  - 会话缓存     │  │  - 文档缓存                         │ │ │   │
│  │  │  │  - 查询缓存     │  │  - 配置缓存                         │ │ │   │
│  │  │  └─────────────────┘  └─────────────────────────────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                              ↓                                      │   │
│  │  ┌───────────────────────────────────────────────────────────────┐ │   │
│  │  │                      监控与日志层                             │ │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐ │ │   │
│  │  │  │  同步状态监控   │  │  查询热度统计   │  │  用户行为分析 │ │ │   │
│  │  │  └─────────────────┘  └─────────────────┘  └───────────────┘ │ │   │
│  │  └───────────────────────────────────────────────────────────────┘ │   │
│  │                                                                         │
│  └─────────────────────────────────────────────────────────────────────────┘
```

### 2.2 文档处理流水线架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       文档处理 ETL 流水线                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                         Extract (提取阶段)                        │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │ │
│  │  │Tika文档   │ │Markdown   │ │PDF文档    │ │云服务文档 │        │ │
│  │  │  读取器    │ │  读取器    │ │  读取器    │ │  读取器   │        │ │
│  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘        │ │
│  │        │             │             │             │               │ │
│  │        └─────────────┴─────────────┴─────────────┘               │ │
│  │                            ↓                                      │ │
│  │                    原始文档列表 (Raw Documents)                   │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                       Transform (转换阶段)                        │ │
│  │                                                                   │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │                    分块策略处理                              │ │ │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐  │ │ │
│  │  │  │Token分块  │ │语义分块   │ │结构感知   │ │混合分块   │  │ │ │
│  │  │  │          │ │          │ │分块       │ │          │  │ │ │
│  │  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘  │ │ │
│  │  └────────┼─────────────┼─────────────┼─────────────┼────────┘ │ │
│  │           └─────────────┴─────────────┴─────────────┘          │ │
│  │                            ↓                                    │ │
│  │                    分块后文档 (Chunked Documents)               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                         Enrich (增强阶段)                         │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │ │
│  │  │关键词提取 │ │结构信息   │ │语言检测   │ │文档分类   │        │ │
│  │  │          │ │丰富       │ │           │ │           │        │ │
│  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘        │ │
│  │        └─────────────┴─────────────┴─────────────┘               │ │
│  │                            ↓                                      │ │
│  │                    增强后文档 (Enriched Documents)                │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                    ↓                                   │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                          Load (加载阶段)                          │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  向量化处理 → 向量索引构建 → 元数据存储 → 文档持久化        │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                            ↓                                      │ │
│  │                    可检索知识库 (Searchable Knowledge Base)      │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 2.3 RAG问答流程架构（面向基层民警优化）

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          RAG 问答流程                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  民警提问: "打架怎么处理？要拘留吗？"                                    │
│                                    ↓                                    │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      问题处理 (Query Processing)                  │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │ │
│  │  │ 问题改写  │ │ 意图识别  │ │ 语义扩展  │ │ 地域适配  │        │ │
│  │  │          │ │ 执法咨询  │ │ 打架→殴打 │ │ 市/区县级 │        │ │
│  │  │          │ │          │ │ 他人      │ │ 文件优先  │        │ │
│  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘        │ │
│  └────────┼─────────────┼─────────────┼─────────────┼────────────────┘ │
│           └─────────────┴─────────────┴─────────────┘                  │
│                              ↓                                          │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      检索阶段 (Retrieval)                         │ │
│  │                                                                   │ │
│  │  ┌───────────────────────────────────────────────────────────┐   │ │
│  │  │                    混合搜索策略                           │   │ │
│  │  │                                                           │   │ │
│  │  │  ┌─────────────────┐    ┌─────────────────┐              │   │ │
│  │  │  │   向量搜索      │    │   全文搜索      │              │   │ │
│  │  │  │  (Vector Search)│    │ (Full-Text)    │              │   │ │
│  │  │  │  - 语义相似度   │    │ - BM25算法     │              │   │ │
│  │  │  │  - HNSW索引    │    │ - 中文分词     │              │   │ │
│  │  │  └────────┬────────┘    └────────┬────────┘              │   │ │
│  │  │           │                      │                        │   │ │
│  │  │           └──────────┬───────────┘                        │   │ │
│  │  │                      ↓                                    │   │ │
│  │  │           ┌─────────────────────┐                        │   │ │
│  │  │           │   结果融合 (RRF)    │                        │   │ │
│  │  │           └──────────┬──────────┘                        │   │ │
│  │  └──────────────────────┼───────────────────────────────────┘   │ │
│  │                         ↓                                         │ │
│  │              初始检索结果 (20-50个)                               │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              ↓                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      重排序阶段 (Reranking)                       │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  ┌─────────────────┐  ┌─────────────────┐                  │ │ │
│  │  │  │  Cross-Encoder  │  │  时效性排序     │                  │ │ │
│  │  │  │   重排序        │  │  新规定优先     │                  │ │ │
│  │  │  └────────┬────────┘  └────────┬────────┘                  │ │ │
│  │  │           └────────┬───────────┘                            │ │ │
│  │  │                  ↓                                          │ │ │
│  │  │           精排结果 (Top 5-10)                                │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              ↓                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      上下文构建 (Context Building)                │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  1. 相关法律条款筛选                                        │ │ │
│  │  │  2. 执法依据标注                                            │ │ │
│  │  │  3. 来源引用（原发机关、文件号）                            │ │ │
│  │  │  4. 地域/时效信息标注                                       │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  │                              ↓                                    │ │
│  │              增强上下文 (Enhanced Context)                        │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              ↓                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      生成阶段 (Generation)                        │ │
│  │  ┌─────────────────────────────────────────────────────────────┐ │ │
│  │  │  ┌─────────────────┐  ┌─────────────────┐                  │ │ │
│  │  │  │  通义千问(Qwen) │  │  执法场景提示词 │                  │ │ │
│  │  │  │   大语言模型    │  │  (Prompt Eng.)  │                  │ │ │
│  │  │  └────────┬────────┘  └────────┬────────┘                  │ │ │
│  │  │           └────────┬───────────┘                            │ │ │
│  │  │                  ↓                                          │ │ │
│  │  │           生成的回答内容                                      │ │ │
│  │  └─────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────┘ │
│                              ↓                                         │
│  ┌───────────────────────────────────────────────────────────────────┐ │
│  │                      后处理 (Post-Processing)                     │ │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐        │ │
│  │  │ 答案格式化 │ │ 法条引用  │ │ 敏感过滤  │ │ 结果缓存  │        │ │
│  │  │          │ │ 标注      │ │          │ │          │        │ │
│  │  └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘        │ │
│  └────────┼─────────────┼─────────────┼─────────────┼────────────────┘ │
│           └─────────────┴─────────────┴─────────────┘                 │
│                              ↓                                        │
│  返回答案: "根据《治安管理处罚法》第43条，打人致轻微伤处五日以上十日以下拘留..." │
│  (附带法律条款原文链接、来源文件号、发布机关)                          │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心组件设计

### 3.1 文档处理器组件

#### 3.1.1 组件职责

```
┌─────────────────────────────────────────────────────────────────────┐
│                       Document Processor                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  职责:                                                              │
│  1. 文档格式识别和解析                                               │
│  2. 文档内容提取                                                     │
│  3. 文档结构分析                                                     │
│  4. 支持多格式文档处理                                               │
│                                                                     │
│  输入:  File/MultipartFile/Resource                                 │
│  输出:  List<Document>                                               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

#### 3.1.2 处理器类图

```
┌─────────────────────┐
│  DocumentProcessor  │
│     (Interface)     │
├─────────────────────┤
│ + process()         │
│ + supportedTypes()  │
│ + getPriority()     │
└──────────┬──────────┘
           ▲
           │
           │ implements
           │
┌──────────┼──────────┐     ┌─────────────────────┐     ┌─────────────────────┐
│UniversalDocument │     │ MarkdownDocument     │     │ PdfDocumentProcessor │
│   Processor      │     │    Processor         │     │                     │
├──────────────────┤     ├──────────────────────┤     ├──────────────────────┤
│ - tokenSplitter  │     │ - tokenSplitter      │     │ - tikaReader         │
│ - enrichers      │     │ - markdownParser     │     │ - structureAnalyzer  │
├──────────────────┤     ├──────────────────────┤     ├──────────────────────┤
│ + process()      │     │ + process()          │     │ + process()          │
│ + supportedTypes()│     │ + supportedTypes()  │     │ + supportedTypes()   │
└──────────────────┘     └──────────────────────┘     └──────────────────────┘
           │
           │ uses
           │
┌──────────┴──────────┐     ┌─────────────────────┐
│  TikaDocumentReader │     │ MarkdownDocument    │
│                     │     │    Reader           │
├─────────────────────┤     ├─────────────────────┤
│ + get()             │     │ + get()             │
└─────────────────────┘     └─────────────────────┘
```

### 3.2 分块策略组件

#### 3.2.1 分块策略类型

```
┌─────────────────────────────────────────────────────────────────────┐
│                       Chunking Strategies                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    Token-Based Strategies                     │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                    │ │
│  │  │TokenTextSplitter│  │ChineseTokenText│                    │ │
│  │  │                 │  │  Splitter       │                    │ │
│  │  │ - 基于token计数 │  │ - 中文优化      │                    │ │
│  │  │ - 重叠处理      │  │ - 语义边界      │                    │ │
│  │  └─────────────────┘  └─────────────────┘                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    Semantic-Based Strategies                  │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                    │ │
│  │  │SemanticChunker │  │ StructureAware  │                    │ │
│  │  │                 │  │   Chunking      │                    │ │
│  │  │ - 基于语义相似度│  │ - Markdown结构  │                    │ │
│  │  │ - 段落边界      │  │ - 标题层级      │                    │ │
│  │  └─────────────────┘  └─────────────────┘                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    Hybrid Strategies                          │ │
│  │  ┌─────────────────────────────────────────────────────────┐ │ │
│  │  │              HybridChunkingStrategy                     │ │ │
│  │  │  - 语义分块 + Token细粒度分块                           │ │ │
│  │  │  - 自适应分块大小                                       │ │ │
│  │  └─────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 向量存储组件

#### 3.3.1 向量存储架构

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Vector Store Architecture                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                     VectorStore Interface                     │ │
│  ├───────────────────────────────────────────────────────────────┤ │
│  │ + add(List<Document>)                                         │ │
│  │ + delete(String id)                                           │ │
│  │ + similaritySearch(SearchRequest)                             │ │
│  │ + hybridSearch(HybridSearchRequest)                           │ │
│  │ + update(List<Document>)                                      │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                              ↑                                      │
│                              │ implements                          │
│                              │                                      │
│  ┌──────────────────────────┴──────────────────────────────────┐  │
│  │                                                          │     │
│  │  ┌────────────────────────────────────────────────────┐  │     │
│  │  │            SeekDBVectorStore                       │  │     │
│  │  ├────────────────────────────────────────────────────┤  │     │
│  │  │ 职责:                                               │  │     │
│  │  │ - 向量索引管理                                      │  │     │
│  │  │ - 混合搜索实现                                      │  │     │
│  │  │ - 元数据过滤                                       │  │     │
│  │  └────────────────────────────────────────────────────┘  │     │
│  │                                                          │     │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    索引类型支持                               │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                    │ │
│  │  │     HNSW        │  │     IVF         │                    │ │
│  │  │ - 高精度        │  │ - 大规模优化    │                    │ │
│  │  │ - 高内存使用    │  │ - 较低精度      │                    │ │
│  │  │ - 亚秒级查询    │  │ - 快速检索      │                    │ │
│  │  └─────────────────┘  └─────────────────┘                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    相似度计算                                 │ │
│  │  ┌─────────────────┐  ┌─────────────────┐                    │ │
│  │  │   余弦相似度    │  │   欧氏距离      │                    │ │
│  │  │  (Cosine)       │  │  (Euclidean)    │                    │ │
│  │  └─────────────────┘  └─────────────────┘                    │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.4 RAG服务组件

#### 3.4.1 RAG服务类图

```
┌─────────────────────────────────────────────────────────────────────┐
│                          RAG Service                                 │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                      RAGService                               │ │
│  ├───────────────────────────────────────────────────────────────┤ │
│  │ - vectorStore: VectorStore                                   │ │
│  │ - embeddingModel: EmbeddingModel                             │ │
│  │ - chatClient: ChatClient                                     │ │
│  │ - rerankModel: RerankModel (optional)                        │ │
│  ├───────────────────────────────────────────────────────────────┤ │
│  │ + queryWithRAG(String, String): String                       │ │
│  │ + streamQueryWithRAG(String, String): Flux<String>           │ │
│  │ + getRetrievedDocuments(String, String): List<Document>      │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│       │                              │                              │
│       │ uses                         │ uses                         │
│       ↓                              ↓                              │
│  ┌─────────────┐              ┌─────────────┐                      │
│  │Retriever    │              │Generator    │                      │
│  │             │              │             │                      │
│  ├─────────────┤              ├─────────────┤                      │
│  │+ retrieve() │              │+ generate() │                      │
│  │+ rerank()   │              │+ buildPrompt│                      │
│  └─────────────┘              └─────────────┘                      │
│                                                                     │
│       │                              │                              │
│       │ uses                         │ uses                         │
│       ↓                              ↓                              │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │                    外部服务                                   │ │
│  │  ┌─────────────────┐  ┌─────────────────────────────────────┐ │ │
│  │  │  Vector Store   │  │  LLM (DashScope Qwen)              │ │ │
│  │  │  (SeekDB)       │  │                                     │ │ │
│  │  └─────────────────┘  └─────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 四、数据流设计

### 4.1 文档上传数据流

```
用户上传文档
     │
     ↓
┌────────────────┐
│   文件验证     │ ← 文件类型、大小、格式验证
│  Validator     │
└───────┬────────┘
        │
        ↓
┌────────────────┐
│  文件存储      │ ← 临时存储原始文件
│   Storage     │
└───────┬────────┘
        │
        ↓
┌────────────────┐     ┌────────────────┐
│ 异步任务队列   │ →   │ 文档处理服务   │
│   Queue       │     │  Processor     │
└───────┬────────┘     └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  文档解析      │ ← Tika/Markdown解析
        │              │   Parser      │
        │              └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  内容分块      │
        │              │   Chunker     │
        │              └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  元数据增强    │
        │              │   Enricher    │
        │              └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  向量嵌入      │ ← DashScope Embedding
        │              │   Embedding   │
        │              └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  向量存储      │ ← SeekDB
        │              │   VectorStore │
        │              └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  元数据存储    │ ← MySQL
        │              │   MetadataDB  │
        │              └───────┬────────┘
        │                      │
        └──────────────────────┘
                      │
                      ↓
              更新处理状态
```

### 4.2 问答请求数据流

```
用户提问
     │
     ↓
┌────────────────┐
│  请求验证      │ ← 认证、参数验证
│  Validator    │
└───────┬────────┘
        │
        ↓
┌────────────────┐
│  会话管理      │ ← 获取/创建会话
│  SessionMgr   │
└───────┬────────┘
        │
        ↓
┌────────────────┐     ┌────────────────┐
│  问题处理      │ →   │  检索服务      │
│   QueryProc   │     │   Retriever    │
└───────┬────────┘     └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  混合搜索      │
        │              │   HybridSearch │
        │              └───────┬────────┘
        │                      │
        │                      ↓
        │              ┌────────────────┐
        │              │  结果重排序    │
        │              │   Reranker    │
        │              └───────┬────────┘
        │                      │
        └──────────────────────┘
                      │
                      ↓
┌────────────────┐
│  上下文构建    │ ← 组装检索结果
│  ContextBuilder│
└───────┬────────┘
        │
        ↓
┌────────────────┐
│  提示词生成    │ ← Prompt Engineering
│   PromptGen   │
└───────┬────────┘
        │
        ↓
┌────────────────┐
│  LLM生成      │ ← 通义千问
│   LLMGenerator│
└───────┬────────┘
        │
        ↓
┌────────────────┐
│  结果后处理    │ ← 格式化、过滤、缓存
│  PostProcessor │
└───────┬────────┘
        │
        ↓
返回答案和来源
```

---

## 五、部署架构

### 5.1 生产环境部署架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          生产环境部署架构                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│                          ┌─────────────────┐                            │
│                          │    用户请求      │                            │
│                          └────────┬────────┘                            │
│                                   │                                     │
│                                   ↓                                     │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    负载均衡层 (Load Balancer)                    │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                       │   │
│  │  │   Nginx         │  │   云SLB         │                       │   │
│  │  │  (可选)         │  │  (阿里云SLB)    │                       │   │
│  │  └────────┬────────┘  └────────┬────────┘                       │   │
│  └───────────┼────────────────────┼─────────────────────────────────┘   │
│              │                    │                                    │
│              └─────────┬──────────┘                                    │
│                        ↓                                               │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                   API网关层 (Spring Cloud Gateway)              │   │
│  │  ┌───────────────────────────────────────────────────────────┐ │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐│ │   │
│  │  │  │  路由转发  │ │  认证授权  │ │  限流熔断 │ │  日志追踪 ││ │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘│ │   │
│  │  └───────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────┬───────────────┘   │
│                                                    │                   │
│                         ┌──────────────────────────┼──┐                │
│                         │                          │  │                │
│                         ↓                          ↓  ↓                │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │                 应用服务层 (Application Services)             │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │   │
│  │  │  KnowledgeBase  │  │   Document      │  │     Chat        │ │   │
│  │  │    Service      │  │    Service      │  │    Service      │ │   │
│  │  │   (Pod 1)       │  │   (Pod 2)       │  │   (Pod 3)       │ │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘ │   │
│  │                                                                │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │   │
│  │  │    RAG Service  │  │   User Service  │  │   Admin Service │ │   │
│  │  │   (Pod 4)       │  │   (Pod 5)       │  │   (Pod 6)       │ │   │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘ │   │
│  └─────────────────────────────────────────────────┬───────────────┘   │
│                                                    │                   │
│                          ┌─────────────────────────┼─────┐             │
│                          │                         │     │             │
│                          ↓                         ↓     ↓             │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │                      缓存层 (Cache Layer)                     │   │
│  │  ┌─────────────────┐  ┌─────────────────┐                     │   │
│  │  │     Redis       │  │   Caffeine      │                     │   │
│  │  │  (集群模式)     │  │   (本地缓存)    │                     │   │
│  │  └─────────────────┘  └─────────────────┘                     │   │
│  └─────────────────────────────────────────────────┬───────────────┘   │
│                                                    │                   │
│                                                    ↓                   │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │                    数据存储层 (SeekDB)                        │   │
│  │  ┌─────────────────────────────────────────────────────────┐ │   │
│  │  │  ┌─────────────────┐  ┌─────────────────┐              │ │   │
│  │  │  │   SeekDB主节点  │  │  SeekDB从节点   │              │ │   │
│  │  │  │   (Master)      │  │   (Replica)     │              │ │   │
│  │  │  └─────────────────┘  └─────────────────┘              │ │   │
│  │  └─────────────────────────────────────────────────────────┘ │   │
│  │                                                                │   │
│  └─────────────────────────────────────────────────┬───────────────┘   │
│                                                    │                   │
│                                                    ↓                   │
│  ┌───────────────────────────────────────────────────────────────┐   │
│  │                    外部服务 (External Services)               │   │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌────────────────┐│   │
│  │  │  阿里云DashScope│  │    飞书API      │  │  监控系统      ││   │
│  │  │  - 嵌入模型     │  │  (可选)         │  │  - Prometheus ││   │
│  │  │  - 大语言模型   │  │                 │  │  - Grafana    ││   │
│  │  └─────────────────┘  └─────────────────┘  └────────────────┘│   │
│  └───────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Kubernetes部署架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Kubernetes 部署架构                                 │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  apiVersion: v1                                                        │
│  kind: Namespace                                                       │
│  metadata:                                                             │
│   name: knowledge-base                                                 │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     ConfigMap & Secret                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  configmap/knowledgebase-config                                 │   │
│  │  └── application.yml 配置                                        │   │
│  │                                                                  │   │
│  │  secret/knowledgebase-secrets                                   │   │
│  │  └── API Keys, 数据库密码等敏感信息                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Deployment (主应用)                         │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  deployment/knowledgebase-system                                │   │
│  │  replicas: 3                                                    │   │
│  │  strategy: RollingUpdate                                        │   │
│  │  containers:                                                    │   │
│  │    - name: knowledgebase                                        │   │
│  │      image: knowledgebase-system:latest                         │   │
│  │      ports:                                                     │   │
│  │        - containerPort: 8080                                    │   │
│  │      resources:                                                 │   │
│  │        requests:                                                │   │
│  │          memory: "2Gi"                                          │   │
│  │          cpu: "1"                                               │   │
│  │        limits:                                                  │   │
│  │          memory: "4Gi"                                          │   │
│  │          cpu: "2"                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Service (内部)                              │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  service/knowledgebase-internal                                 │   │
│  │  type: ClusterIP                                                │   │
│  │  ports:                                                         │   │
│  │    - port: 8080                                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     Ingress (外部访问)                          │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  ingress/knowledgebase-ingress                                  │   │
│  │  rules:                                                         │   │
│  │    - host: kb.example.com                                       │   │
│  │      http:                                                      │   │
│  │        paths:                                                   │   │
│  │          - path: /api/v1                                        │   │
│  │            backend:                                             │   │
│  │              service:                                           │   │
│  │                name: knowledgebase-internal                     │   │
│  │                port:                                            │   │
│  │                  number: 8080                                   │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     HPA (自动扩缩容)                            │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  horizontalpodautoscaler/knowledgebase-hpa                      │   │
│  │  minReplicas: 3                                                 │   │
│  │  maxReplicas: 10                                                │   │
│  │  metrics:                                                       │   │
│  │    - type: Resource                                             │   │
│  │      resource:                                                  │   │
│  │        name: cpu                                                │   │
│  │        target:                                                  │   │
│  │          type: Utilization                                      │   │
│  │          averageUtilization: 70                                 │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ───────────────────────────────────────────────────────────────────   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     PVC (持久化存储)                            │   │
│  ├─────────────────────────────────────────────────────────────────┤   │
│  │  persistentvolumeclaim/knowledgebase-uploads                    │   │
│  │  accessModes: [ReadWriteOnce]                                   │   │
│  │  resources:                                                     │   │
│  │    requests:                                                    │   │
│  │      storage: 10Gi                                              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 六、MCP集成架构 (新增)

### 6.1 MCP架构概述

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     Model Context Protocol (MCP) 架构                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                    MCP Client (外部系统)                      │     │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐               │     │
│  │  │ Claude    │  │  IDE插件   │  │ 其他AI工具 │               │     │
│  │  └─────┬─────┘  └─────┬─────┘  └─────┬─────┘               │     │
│  └────────┼───────────────┼───────────────┼───────────────────────┘     │
│           │               │               │                            │
│           └───────────────┼───────────────┘                            │
│                           ↓                                          │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                    MCP协议层                                  │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │  JSON-RPC 2.0 / HTTP / WebSocket                  │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  └───────────────────────────────┬───────────────────────────────┘     │
│                                  │                                    │
│  ┌──────────────────────────────┴───────────────────────────────┐     │
│  │                   MCP Server (本系统)                       │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐     │    │     │
│  │  │  │  │  │ 请求路由工具注册     │  │  认证授权  │     │    │     │
│  │  │  │ Registry │  │  Router   │  │  Auth     │     │    │     │
│  │  │  └───────────┘  └───────────┘  └───────────┘     │    │     │
│  │  │                                                 │    │     │
│  │  │  ┌───────────────────────────────────────────┐  │    │     │
│  │  │  │           Tool Handlers                 │  │    │     │
│  │  │  │  ┌─────────────────┐ ┌─────────────────┐ │  │    │     │
│  │  │  │  │KnowledgeBaseTool│ │ DocumentTool   │ │  │    │     │
│  │  │  │  │                 │ │                 │ │  │    │     │
│  │  │  │  │ - createKB()   │ │ - upload()     │ │  │    │     │
│  │  │  │  │ - queryKB()    │ │ - search()     │ │  │    │     │
│  │  │  │  └─────────────────┘ └─────────────────┘ │  │    │     │
│  │  │  └───────────────────────────────────────────┘  │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                                                         │
│                              ↓                                         │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                    业务服务层                                 │     │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐               │     │
│  │  │ Knowledge │  │  Document │  │  RAG      │               │     │
│  │  │ BaseSvc   │  │    Svc    │  │   Svc     │               │     │
│  │  └───────────┘  └───────────┘  └───────────┘               │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 6.2 MCP工具定义

```java
@McpTool(description = "知识库管理工具集")
public class KnowledgeBaseMCPTool {
    
    @Tool(description = "创建新的知识库")
    public KnowledgeBase createKnowledgeBase(
            @ToolParam(description = "知识库名称") String name,
            @ToolParam(description = "知识库描述", required = false) String description) {
        // 实现逻辑
    }
    
    @Tool(description = "基于知识库进行问答")
    public String queryKnowledgeBase(
            @ToolParam(description = "知识库ID") Long knowledgeBaseId,
            @ToolParam(description = "用户问题") String question) {
        // 实现逻辑
    }
    
    @Tool(description = "上传文档到知识库")
    public Document uploadDocument(
            @ToolParam(description = "知识库ID") Long knowledgeBaseId,
            @ToolParam(description = "文档内容") String content,
            @ToolParam(description = "文档标题") String title) {
        // 实现逻辑
    }
    
    @Tool(description = "搜索知识库文档")
    public List<Document> searchDocuments(
            @ToolParam(description = "知识库ID") Long knowledgeBaseId,
            @ToolParam(description = "搜索关键词") String query) {
        // 实现逻辑
    }
}
```

---

## 七、可观测性架构 (新增)

### 7.1 可观测性架构概述

```
┌─────────────────────────────────────────────────────────────────────────┐
│                       可观测性架构 (Observability)                      │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌───────────────────────────────────────────────────────────────┐     │
│  │                    指标收集层 (Metrics)                       │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │  Spring AI Metrics                                │    │     │
│  │  │  - ChatClient调用次数和耗时                       │    │     │
│  │  │  - VectorStore查询延迟                           │    │     │
│  │  │  - Document处理吞吐量                            │    │     │
│  │  │  - MCP工具调用统计                              │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  └───────────────────────────────┬───────────────────────────────┘     │
│                                  │                                    │
│  ┌──────────────────────────────┴───────────────────────────────┐     │
│  │                    链路追踪层 (Tracing)                      │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │  OpenTelemetry Integration                       │    │     │
│  │  │  ┌───────────┐  ┌───────────┐  ┌───────────┐  │    │     │
│  │  │  │  TraceId  │  │  SpanId   │  │  Events   │  │    │     │
│  │  │  │  生成     │  │  生成     │  │  记录     │  │    │     │
│  │  │  └───────────┘  └───────────┘  └───────────┘  │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  └───────────────────────────────┬───────────────────────────────┘     │
│                                  │                                    │
│  ┌──────────────────────────────┴───────────────────────────────┐     │
│  │                    日志层 (Logging)                         │     │
│  │  ┌─────────────────────────────────────────────────────┐    │     │
│  │  │  结构化日志 + 上下文追踪                           │    │     │
│  │  │  - JSON格式输出                                  │    │     │
│  │  │  - TraceId注入                                  │    │     │
│  │  │  - 日志级别动态调整                             │    │     │
│  │  └─────────────────────────────────────────────────────┘    │     │
│  └───────────────────────────────┬───────────────────────────────┘     │
│                                  │                                    │
│  ┌──────────────────────────────┴───────────────────────────────┐     │
│  │                    数据导出层 (Export)                      │     │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────┐               │     │
│  │  │ Prometheus│  │  OTLP     │  │  日志收集  │               │     │
│  │  │ 指标导出  │  │  追踪导出  │  │  (ELK)    │               │     │
│  │  └───────────┘  └───────────┘  └───────────┘               │     │
│  └───────────────────────────────────────────────────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 7.2 关键指标定义

```java
@Configuration
public class KnowledgeBaseMetrics {
    
    private final MeterRegistry meterRegistry;
    
    // 文档处理指标
    private final Counter documentProcessedCounter;
    private final Timer documentProcessingTimer;
    
    // RAG查询指标
    private final Counter ragQueryCounter;
    private final Timer ragQueryTimer;
    private final Timer vectorSearchTimer;
    
    // MCP调用指标
    private final Counter mcpToolCounter;
    private final Timer mcpToolTimer;
    
    public KnowledgeBaseMetrics(MeterRegistry meterRegistry) {
        this.meterRegistry = meterRegistry;
        
        this.documentProcessedCounter = Counter.builder("kb.document.processed.count")
            .description("Number of processed documents")
            .register(meterRegistry);
            
        this.documentProcessingTimer = Timer.builder("kb.document.processing.duration")
            .description("Document processing duration")
            .register(meterRegistry);
            
        this.ragQueryCounter = Counter.builder("kb.rag.query.count")
            .description("Number of RAG queries")
            .register(meterRegistry);
            
        this.ragQueryTimer = Timer.builder("kb.rag.query.duration")
            .description("RAG query duration")
            .register(meterRegistry);
            
        this.vectorSearchTimer = Timer.builder("kb.vector.search.duration")
            .description("Vector search duration")
            .register(meterRegistry);
            
        this.mcpToolCounter = Counter.builder("kb.mcp.tool.calls")
            .description("Number of MCP tool invocations")
            .register(meterRegistry);
    }
}
```

---

## 九、权限模型设计

### 9.1 权限体系概述

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      公安知识库权限管理体系                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    文档分类维度                                  │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │   │
│  │  │   警种     │ │   业务    │ │   来源    │ │   类型    │       │   │
│  │  │ 治安/刑侦  │ │ 户籍/治安 │ │ 省厅/市局 │ │ 规章制度  │       │   │
│  │  │ 交警/禁毒  │ │ 刑侦/经侦 │ │ 区县局    │ │ 培训资料  │       │   │
│  │  │ 社区/特警  │ │ 网安/反恐 │ │ 派出所    │ │ 总结文件  │       │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    文档可见性类型                                │   │
│  │  ┌───────────────────────────────────────────────────────────┐ │   │
│  │  │  ┌───────────────┐  ┌─────────────────────────────────┐  │ │   │
│  │  │  │    私有文档    │  │          共享文档               │  │ │   │
│  │  │  │               │  │                                 │  │ │   │
│  │  │  │ - 仅创建者    │  │  - 全局可见（需审核）           │  │ │   │
│  │  │  │ - 本人使用    │  │  - 按警种/业务分类可见          │  │ │   │
│  │  │  │ - 不可分享    │  │  - 支持全文检索                 │  │ │   │
│  │  │  └───────────────┘  └─────────────────────────────────┘  │ │   │
│  │  └───────────────────────────────────────────────────────────┘ │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    发布审核流程                                  │   │
│  │                                                                   │   │
│  │  普通文档:                                                        │   │
│  │  ┌──────────┐     ┌──────────┐     ┌──────────┐                │   │
│  │  │  创建人   │ ──→ │  私有使用 │ ──→ │  发布共享 │                │   │
│  │  │  创建文档 │     │  (自动)   │     │ (需审核)  │                │   │
│  │  └──────────┘     └──────────┘     └────┬─────┘                │   │
│  │                                          │                       │   │
│  │                                          ↓                       │   │
│  │  ┌──────────┐     ┌──────────┐                               │   │
│  │  │  管理员   │ ──→ │  全局发布 │                               │   │
│  │  │  审核通过 │     │          │                               │   │
│  │  └──────────┘     └──────────┘                               │   │
│  │                                                                   │   │
│  │  机制类文档:                                                      │   │
│  │  ┌──────────┐     ┌──────────┐     ┌──────────┐                │   │
│  │  │  创建人   │ ──→ │  仅限本人 │ ──→ │ 管理员审核 │               │   │
│  │  │  创建机制 │     │  使用     │     │ (强制)     │               │   │
│  │  └──────────┘     └──────────┘     └────┬─────┘                │   │
│  │                                          │                       │   │
│  │                         ┌────────────────┼───────────────┐       │   │
│  │                         ↓                ↓               │       │   │
│  │                   ┌──────────┐    ┌──────────┐          │       │   │
│  │                   │  全局发布 │    │  驳回     │          │       │   │
│  │                   │  (通过)   │    │          │          │       │   │
│  │                   └──────────┘    └──────────┘          │       │   │
│  │                                                          ↓       │   │
│  │                                                   ┌──────────┐   │   │
│  │                                                   │ 返回修改  │   │   │
│  │                                                   └──────────┘   │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 9.2 权限控制策略

```java
public enum DocumentVisibility {
    // 私有文档 - 仅创建者本人可见
    PRIVATE("private", "私有", "仅创建者本人使用"),

    // 共享文档 - 全局可见，需管理员审核
    SHARED审核中("shared_pending", "共享待审核", "等待管理员审核"),
    SHARED("shared", "共享", "全局可见，需审核后发布"),

    // 机制类文档特殊处理
    MECHANISM_PRIVATE("mechanism_private", "机制私有", "机制类，仅限本人使用"),
    MECHANISM审核中("mechanism_pending", "机制待审核", "机制类，等待审核"),

    // 审核通过后可发布
    MECHANISM_SHARED("mechanism_shared", "机制共享", "机制类，审核后全局共享")
}

public class PermissionPolicy {
    // 普通文档发布策略
    public static boolean canPublishShared(Long userId, Document doc) {
        // 普通文档: 任何用户都可以申请发布共享
        // 但需要管理员审核
        return doc.getVisibility() == DocumentVisibility.PRIVATE
            || doc.getVisibility() == DocumentVisibility.SHARED审核中;
    }

    // 机制类文档发布策略
    public static boolean canPublishMechanism(Long userId, Document doc) {
        // 机制类: 必须经过管理员审核才能发布共享
        // 不能直接发布共享
        return doc.getVisibility() == DocumentVisibility.MECHANISM_PRIVATE
            || doc.getVisibility() == DocumentVisibility.MECHANISM审核中;
    }

    // 文档可见性判断
    public static boolean canAccess(Long userId, Document doc) {
        // 私有文档: 仅创建者可访问
        if (doc.isPrivate()) {
            return doc.getCreatorId().equals(userId);
        }

        // 共享文档: 全局可访问
        if (doc.isShared()) {
            return true;
        }

        // 审核中文档: 创建者可访问
        return doc.getCreatorId().equals(userId);
    }
}
```

### 9.3 用户角色定义

| 角色 | 权限范围 | 可执行操作 |
|------|----------|-----------|
| **普通民警** | 私有文档 + 已审核共享文档 | 创建、查询、收藏、提问 |
| **知识管理员** | 全局文档 | 创建、审核、发布、删除、统计 |
| **系统管理员** | 全局 | 用户管理、系统配置、角色分配、审计查看 |

---

## 十、外部系统对接

### 10.1 治安平台对接架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    治安平台数据同步架构                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                     知识库系统                                   │   │
│  │  ┌───────────────────────────────────────────────────────────┐ │   │
│  │  │  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐ │ │   │
│  │  │  │  定时拉取服务  │  │  手动同步服务  │  │  同步状态监控 │ │ │   │
│  │  │  │ (每日凌晨)    │  │  (管理员触发)  │  │              │ │ │   │
│  │  │  └───────┬───────┘  └───────┬───────┘  └───────┬───────┘ │ │   │
│  │  │          │                  │                  │         │ │   │
│  │  │          └──────────────────┼──────────────────┘         │ │   │
│  │  │                             ↓                            │ │   │
│  │  │  ┌───────────────────────────────────────────────────┐  │ │   │
│  │  │  │              文档处理引擎                         │  │ │   │
│  │  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐      │  │ │   │
│  │  │  │  │ Word解析  │ │ PDF解析   │ │ Excel解析 │      │  │ │   │
│  │  │  │  └───────────┘ └───────────┘ └───────────┘      │  │ │   │
│  │  │  └───────────────────────────────────────────────────┘  │ │   │
│  │  │                             ↓                            │ │   │
│  │  │  ┌───────────────────────────────────────────────────┐  │ │   │
│  │  │  │              向量化处理 + 存储                    │  │ │   │
│  │  │  └───────────────────────────────────────────────────┘  │ │   │
│  │  └─────────────────────────────────────────────────────────┘ │   │
│  └───────────────────────────────┬───────────────────────────────┘   │
│                                  │                                   │
│  ┌───────────────────────────────┴───────────────────────────────┐   │
│  │                        同步协议层                             │   │
│  │  ┌─────────────────────────────────────────────────────────┐ │   │
│  │  │  REST API / WebService / 数据库连接池                  │ │   │
│  │  └─────────────────────────────────────────────────────────┘ │   │
│  └───────────────────────────────┬───────────────────────────────┘   │
│                                  │                                   │
│  ┌───────────────────────────────┴───────────────────────────────┐   │
│  │                       公安专网隔离区                          │   │
│  │  ┌─────────────────────────────────────────────────────────┐ │   │
│  │  │                    数据摆渡系统                         │ │   │
│  │  │  (确保公安专网与外部系统物理隔离)                       │ │   │
│  │  └─────────────────────────────────────────────────────────┘ │   │
│  └───────────────────────────────┬───────────────────────────────┘   │
│                                  │                                   │
│  ┌───────────────────────────────┴───────────────────────────────┐   │
│  │                     治安平台                                   │   │
│  │  ┌─────────────────────────────────────────────────────────┐ │   │
│  │  │  ┌───────────┐ ┌───────────┐ ┌───────────┐             │ │   │
│  │  │  │ 法规文件库 │ │ 培训资料  │ │ 制度文档  │             │ │   │
│  │  │  └───────────┘ └───────────┘ └───────────┘             │ │   │
│  │  └─────────────────────────────────────────────────────────┘ │   │
│  │                                                                         │
│  └─────────────────────────────────────────────────────────────────────────┘
```

### 10.2 同步策略设计

```java
public class SecurityPlatformSyncService {

    @Scheduled(cron = "0 0 2 * * ?")  // 每天凌晨2点自动同步
    public void scheduledSync() {
        syncFromSecurityPlatform(false);  // false: 非手动触发
    }

    @PostConstruct
    public void initialSync() {
        syncFromSecurityPlatform(true);  // 首次全量同步
    }

    public SyncResult syncFromSecurityPlatform(boolean manual) {
        SyncResult result = new SyncResult();

        // 1. 获取变更列表
        List<SecurityDoc> changedDocs = securityPlatformClient.getChangedDocuments(
            lastSyncTime,  // 上次同步时间
            manual ? null : LocalDateTime.now()  // 手动同步获取全部
        );

        // 2. 下载文档原文
        for (SecurityDoc doc : changedDocs) {
            try {
                byte[] content = securityPlatformClient.downloadDocument(doc.getId());
                doc.setContent(content);

                // 3. 解析文档格式 (Word/PDF/TXT/Excel)
                Document parsedDoc = documentParser.parse(doc);

                // 4. 保留原文链接
                parsedDoc.setOriginalUrl(doc.getOriginalUrl());
                parsedDoc.setSourcePlatform("治安平台");
                parsedDoc.setSourceDocId(doc.getExternalId());

                // 5. 向量化处理
                embeddingService.embed(parsedDoc);

                // 6. 存储到知识库
                documentRepository.save(parsedDoc);

                result.addSuccess(doc.getId());
            } catch (Exception e) {
                result.addFailed(doc.getId(), e.getMessage());
            }
        }

        // 7. 更新同步时间戳
        lastSyncTime = LocalDateTime.now();

        // 8. 记录同步日志
        syncLogService.log(result, manual);

        return result;
    }

    // 管理员手动触发同步
    public SyncResult manualSync() {
        return syncFromSecurityPlatform(true);
    }
}
```

### 10.3 文档格式支持

| 格式 | 解析库 | 处理说明 |
|------|--------|----------|
| **Word (.doc/.docx)** | Apache POI | 提取正文、标题、表格 |
| **PDF** | Apache PDFBox / PDFParser | 提取文本、保留页码 |
| **TXT** | 标准IO | 简单文本读取 |
| **Excel (.xls/.xlsx)** | Apache POI | 提取单元格内容 |

---

## 十一、监控运维体系

### 11.1 监控架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                      监控运维架构 (Observability)                       │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    同步状态监控                                  │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │   │
│  │  │ 同步任务  │ │ 同步频率  │ │ 同步状态  │ │ 同步日志  │       │   │
│  │  │ 管理     │ │ 统计      │ │ 展示      │ │            │       │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │   │
│  │                                                                   │   │
│  │  监控指标:                                                         │   │
│  │  - 每日同步文档数量                                                │   │
│  │  - 同步成功率/失败率                                               │   │
│  │  - 同步耗时统计                                                    │   │
│  │  - 上次同步时间                                                    │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    查询热度统计                                  │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │   │
│  │  │ 热门搜索  │ │ 高频文档  │ │ 搜索趋势  │ │ 零结果查询 │       │   │
│  │  │ 关键词    │ │ 排行榜    │ │ 分析      │ │ 统计       │       │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │   │
│  │                                                                   │   │
│  │  监控指标:                                                         │   │
│  │  - Top 10 热门搜索词                                               │   │
│  │  - Top 10 被检索最多的文档                                         │   │
│  │  - 日/周/月查询量趋势                                              │   │
│  │  - 无结果搜索词（用于优化知识库）                                  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    用户行为分析                                  │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐       │   │
│  │  │ 活跃用户  │ │ 使用频率  │ │ 功能使用  │ │ 用户画像  │       │   │
│  │  │ 统计      │ │ 分布      │ │ 分布      │ │ 分析       │       │   │
│  │  └───────────┘ └───────────┘ └───────────┘ └───────────┘       │   │
│  │                                                                   │   │
│  │  监控指标:                                                         │   │
│  │  - 日活/月活用户数                                                 │   │
│  │  - 各警种使用分布                                                  │   │
│  │  - 搜索vs对话使用比例                                              │   │
│  │  - 用户操作路径分析                                                │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    告警与通知                                    │   │
│  │  ┌───────────┐ ┌───────────┐ ┌───────────┐                     │   │
│  │  │ 同步失败  │ │ 系统异常  │ │ 安全事件  │                     │   │
│  │  │ 告警      │ │ 告警      │ │ 告警       │                     │   │
│  │  └───────────┘ └───────────┘ └───────────┘                     │   │
│  │                                                                   │   │
│  │  告警方式: 短信 / 钉钉 / 邮件                                      │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 11.2 监控指标定义

```java
@Configuration
public class KnowledgeBaseMonitoringConfig {

    // 1. 同步状态监控
    @Bean
    public Counter syncSuccessCounter() {
        return Counter.builder("kb.sync.document.success")
            .description("同步成功的文档数量")
            .register(meterRegistry);
    }

    @Bean
    public Counter syncFailedCounter() {
        return Counter.builder("kb.sync.document.failed")
            .description("同步失败的文档数量")
            .register(meterRegistry);
    }

    @Bean
    public Timer syncDurationTimer() {
        return Timer.builder("kb.sync.duration")
            .description("同步过程耗时")
            .register(meterRegistry);
    }

    // 2. 查询热度统计
    @Bean
    public Counter queryCounter() {
        return Counter.builder("kb.query.total")
            .description("查询总次数")
            .register(meterRegistry);
    }

    @Bean
    public Timer queryDurationTimer() {
        return Timer.builder("kb.query.duration")
            .description("查询响应时间")
            .register(meterRegistry);
    }

    // 3. 用户行为分析
    @Bean
    public Counter userActiveCounter() {
        return Counter.builder("kb.user.active")
            .description("活跃用户数")
            .register(meterRegistry);
    }

    // 文档访问统计
    private final Map<String, Counter> documentAccessCounters = new ConcurrentHashMap<>();

    public void recordDocumentAccess(String docId) {
        documentAccessCounters.computeIfAbsent(docId,
            id -> Counter.builder("kb.document.access")
                .tag("document_id", id)
                .description("文档访问次数")
                .register(meterRegistry))
            .increment();
    }
}
```

### 11.3 监控面板指标

| 分类 | 指标名称 | 指标说明 | 告警阈值 |
|------|----------|----------|----------|
| **同步监控** | 今日同步文档数 | 当天成功同步的文档数量 | - |
| | 同步成功率 | 同步成功文档/总文档 | < 95% |
| | 上次同步时间 | 最近一次同步完成时间 | > 24小时 |
| | 同步失败数 | 当天同步失败的文档数量 | > 10 |
| **查询监控** | 今日查询量 | 当天查询总次数 | - |
| | 平均响应时间 | 查询平均响应时间 | > 3秒 |
| | 95%响应时间 | 95%查询的响应时间 | > 5秒 |
| | 无结果查询率 | 返回空结果的查询比例 | > 20% |
| **用户监控** | 日活用户数 | 当天活跃用户数量 | - |
| | 使用分布 | 各警种使用占比 | - |
| **系统监控** | CPU使用率 | 服务器CPU使用率 | > 80% |
| | 内存使用率 | JVM内存使用率 | > 85% |
| | 请求错误率 | HTTP请求错误比例 | > 1% |

---

## 十二、安全合规设计

### 12.1 等保适配

```java
@Configuration
public class SecurityComplianceConfig {

    // 等保三级安全要求适配

    // 1. 身份鉴别 - 强密码策略
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder(12);
    }

    // 2. 访问控制 - 基于角色的访问控制
    @Bean
    public RoleBasedAccessControl roleBasedAccessControl() {
        return new RoleBasedAccessControl();
    }

    // 3. 安全审计 - 完整操作日志
    @Aspect
    @Component
    public class AuditLogAspect {

        @Around("@annotation(auditable)")
        public Object audit(ProceedingJoinPoint joinPoint, Auditable auditable) {
            // 记录操作人、操作时间、操作内容、操作结果
            AuditLog log = new AuditLog();
            log.setUserId(SecurityContextHolder.getCurrentUserId());
            log.setOperation(auditable.value());
            log.setTimestamp(LocalDateTime.now());
            log.setIpAddress(WebUtils.getClientIp());
            log.setResource(joinPoint.getSignature().toShortString());

            try {
                Object result = joinPoint.proceed();
                log.setStatus("SUCCESS");
                auditLogRepository.save(log);
                return result;
            } catch (Exception e) {
                log.setStatus("FAILED");
                log.setErrorMessage(e.getMessage());
                auditLogRepository.save(log);
                throw e;
            }
        }
    }

    // 4. 通信安全 - HTTPS强制
    @Bean
    public ServletWebServerFactory servletContainer() {
        TomcatServletWebServerFactory tomcat = new TomcatServletWebServerFactory() {
            @Override
            protected void postProcessContext(Context context) {
                SecurityConstraint securityConstraint = new SecurityConstraint();
                securityConstraint.setUserConstraint("CONFIDENTIAL");
                SecurityCollection collection = new SecurityCollection();
                collection.addPattern("/*");
                securityConstraint.addCollection(collection);
                context.addConstraint(securityConstraint);
            }
        };
        tomcat.addAdditionalTomcatConnectors(httpConnector());
        return tomcat;
    }
}
```

### 12.2 审计日志规范

| 操作类型 | 操作说明 | 记录内容 |
|----------|----------|----------|
| **登录登出** | 用户登录/登出 | 用户ID、时间、IP、设备信息 |
| **文档操作** | 创建/修改/删除文档 | 文档ID、操作内容、影响范围 |
| **查询操作** | 知识库查询 | 查询关键词、查询结果数 |
| **权限操作** | 权限变更/审核 | 变更前后的权限状态 |
| **系统操作** | 系统配置修改 | 配置项、变更值、操作人 |

### 12.3 数据安全

- **传输安全**: 全站HTTPS，公安专网VPN隧道
- **存储安全**: 敏感数据加密存储，数据库加密
- **访问安全**: 基于最小权限原则，细粒度访问控制
- **脱敏处理**: 涉及个人隐私的查询结果自动脱敏

---

**文档版本**: 2.0.0  
**最后更新**: 2025年1月20日
