# 智能问答检索精准率优化方案（基于数据库结构）

## 一、当前问题诊断

### 1.1 代码层面的问题
通过分析 `VectorServiceImpl.java`，发现**向量搜索完全失效**：

```java
// 第188-204行：vectorSimilaritySearch 方法直接回退到全文搜索
private List<SearchResult> vectorSimilaritySearch(...) {
    log.info("直接使用全文搜索作为主要搜索方式，避免向量搜索的数据类型问题");
    return fullTextSearch(keyword, kbId, topK);  // ❌ 向量搜索未启用！
}
```

### 1.2 数据库层面的机会
从 `police_kb.sql` 发现：

1. **已有SeekDB原生函数**: `AI_EMBED('ob_embed', p_content)` - 但代码未使用
2. **向量存储已就绪**: `document_vectors` 表的 `VECTOR` 类型字段已配置
3. **存储过程已定义**: `sp_upsert_document_vector` - 但Java代码未调用

## 二、优化方案（分阶段实施）

### 第一阶段：修复向量搜索（优先级：最高）

**目标**: 恢复SeekDB向量检索功能，利用原生 `AI_EMBED` 函数

**修改文件**: `VectorServiceImpl.java`

**具体任务**:
1. **移除回退逻辑**（第188-204行）
   - 删除直接调用 `fullTextSearch()` 的代码
   - 实现真正的向量相似度搜索

2. **使用SeekDB原生函数**
   - 调用 `AI_EMBED` 生成问题向量
   - 使用 `l2_distance` 或 `cosine_distance` 计算相似度
   - 正确处理 VECTOR 数据类型

3. **修复SQL查询**（参考存储过程 sp_upsert_document_vector）
   ```java
   // 正确示例：
   String sql = "SELECT d.id, d.title, l2_distance(dv.vector, AI_EMBED('ob', ?)) as distance " +
                "FROM document_vectors dv " +
                "JOIN document d ON dv.document_id = d.id " +
                "WHERE d.kb_id = ? " +
                "ORDER BY distance ASC LIMIT ?";
   ```

**预期效果**: 检索精准率提升 30-50%

### 第二阶段：优化分块策略（优先级：高）

**目标**: 实现语义感知的智能分块

**修改文件**: `VectorServiceImpl.java`（splitByParagraph方法）

**具体任务**:
1. **改进语义分块**
   - 基于句子边界分割（保留标点符号）
   - 动态调整分块大小（200-800字符）
   - 增加重叠区域（50-100字符重叠）

2. **利用 metadata 字段**
   ```java
   // 存储分块元数据
   metadata = {
     "source_paragraph": 3,
     "doc_title": "治安管理处罚法",
     "chunk_type": "legal_clause",
     "keywords": ["盗窃", "处罚", "情节严重"]
   }
   ```

3. **针对法律条文的专门策略**
   - 识别"第X条"格式
   - 保持条款完整性
   - 分离款、项内容

**预期效果**: 保持语义完整性，信息丢失减少 60%

### 第三阶段：启用重排序（优先级：高）

**目标**: 实现两阶段检索（粗排+精排）

**修改文件**: 
- `SeekDBConfig.java`（启用配置）
- `VectorServiceImpl.java`（实现重排序逻辑）

**具体任务**:
1. **启用重排序配置**
   ```yaml
   seekdb:
     rag:
       enableReranker: true  # 从 false 改为 true
   ```

2. **集成重排序模型**
   - 使用 `BAAI/bge-reranker-base` 模型
   - 对Top 20结果进行精排
   - 选择Top 5作为最终结果

3. **实现交叉编码**
   ```java
   // 重排序评分计算
   double rerankScore = calculateCrossEncoderScore(question, chunkContent);
   ```

**预期效果**: Top-5精准率提升 20-30%

### 第四阶段：增强提示词工程（优先级：中）

**目标**: 提升回答质量和引用准确性

**修改文件**: `RagServiceImpl.java`（buildPrompt方法）

**具体任务**:
1. **添加Few-shot学习示例**
   ```
   示例1：
   问题：盗窃罪的量刑标准是什么？
   参考：根据《刑法》第二百六十四条，盗窃公私财物，数额较大的，处三年以下有期徒刑...
   回答：盗窃罪的量刑标准主要根据盗窃金额和情节确定...
   ```

2. **增加结构化输出指令**
   ```java
   String prompt = """
   您是公安专网知识库的智能助手。请按以下格式回答：

   ## 回答要点
   [简要总结答案]

   ## 详细说明
   [详细解释]

   ## 法律依据
   - [引用法规名称] 第X条
   - [引用法规名称] 第X条

   ## 注意事项
   [适用条件和限制]

   如果参考文档中没有明确答案，请明确告知："根据当前知识库，未找到相关内容"。
   """;
   ```

3. **添加引用格式要求**
   - 明确要求标注来源
   - 要求标注置信度
   - 要求区分事实和推断

**预期效果**: 回答质量评分提升 25-40%

### 第五阶段：混合搜索权重调优（优先级：中）

**目标**: 优化向量搜索和全文搜索的融合策略

**修改文件**: `SeekDBConfig.java`

**具体任务**:
1. **调整权重配置**
   ```java
   // 调整为更侧重语义检索
   private float vectorWeight = 0.7f;    // 从 0.6 提升到 0.7
   private float fulltextWeight = 0.3f;  // 从 0.4 降低到 0.3
   ```

2. **实现动态权重调整**
   - 根据查询类型（事实型/概念型）动态调整
   - 根据历史准确率反馈优化

3. **启用RRF融合算法**
   ```java
   // 使用 Reciprocal Rank Fusion
   hybrid.put("fusion", "rrf");
   ```

**预期效果**: 复杂问题检索效果提升 15-25%

### 第六阶段：实现查询优化（优先级：中）

**目标**: 提升对复杂问题的理解能力

**修改文件**: `VectorServiceImpl.java`

**具体任务**:
1. **实现HyDE（假设文档嵌入）**
   ```java
   // 先生成假设答案，再用假设答案检索
   String hypotheticalAnswer = generateHypotheticalAnswer(question);
   String questionVector = generateVector(hypotheticalAnswer);
   ```

2. **添加查询扩展**
   - 法律术语同义词扩展
   - 上下位概念扩展
   - 常见问答对匹配

3. **实现查询意图分类**
   - 事实查询（概念定义、流程）
   - 法规查询（法条、条款）
   - 案例查询（类似情况、处理方式）

**预期效果**: 复杂问题理解能力提升 30-40%

## 三、优先级和实施计划

| 阶段 | 任务 | 工作量 | 优先级 | 风险 |
|------|------|--------|--------|------|
| 1 | 修复向量搜索 | 2天 | ⭐⭐⭐⭐⭐ | 中（数据类型兼容性） |
| 2 | 优化分块策略 | 1天 | ⭐⭐⭐⭐ | 低 |
| 3 | 启用重排序 | 2天 | ⭐⭐⭐⭐ | 中（API成本） |
| 4 | 增强提示词 | 1天 | ⭐⭐⭐ | 低 |
| 5 | 权重调优 | 0.5天 | ⭐⭐⭐ | 低 |
| 6 | 查询优化 | 2天 | ⭐⭐⭐ | 中（效果验证） |

**总计**: 8-9天

## 四、验证方案

### 4.1 测试集构建
- 100个常见问题（涵盖法规、流程、案例）
- 包含简单问题和复杂问题
- 标注正确答案（人工评估）

### 4.2 评估指标
- **检索精准率**: Top-5结果的相关性
- **回答准确率**: 生成答案的事实正确性
- **引用准确率**: 参考文档引用的正确性
- **用户满意度**: 实际用户反馈

### 4.3 A/B测试
- 对比优化前后的核心指标
- 分阶段上线，观察效果

## 五、风险和应对

### 5.1 技术风险
1. **SeekDB数据类型问题**
   - 预防：准备详细的错误日志
   - 应对：联系SeekDB团队或使用JSON数组存储向量

2. **重排序API成本**
   - 预防：实现结果缓存
   - 应对：限制重排序频率（每分钟最多N次）

### 5.2 效果风险
1. **优化效果不明显**
   - 预防：建立完整的评估体系
   - 应对：准备回滚方案

## 六、资源需求

1. **开发资源**: 1名后端工程师，8-9天
2. **测试资源**: 1名测试工程师，2-3天
3. **API配额**:
   - 重排序模型：1000次/天
   - Embedding模型：增量10000次/天
4. **SeekDB支持**: 可能需要SeekDB团队协助数据类型问题